<!DOCTYPE html>
<html lang="zh-TW" data-theme="dark">
<head>
  <base target="_top">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
  <title>Meishi Box</title>
  
  <script>
    (function() {
      var saved = localStorage.getItem('app_theme');
      if (saved === 'light') {
        document.documentElement.removeAttribute('data-theme');
      } else {
        document.documentElement.setAttribute('data-theme', 'dark');
      }
    })();
  </script>

  <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/847/847969.png">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css">
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
  
  <style>
    /* [防止白屏閃爍] CSS 配合 JS */
    html { background-color: #000000; }
    html:not([data-theme="dark"]) { background-color: #F2F2F7; }

    /* --- CSS 變數 --- */
    :root {
      --primary: #007AFF;
      --bg: #F2F2F7;
      --card: #FFFFFF;
      --text: #000000;
      --text-sec: #8E8E93;
      --danger: #FF3B30;
      --separator: rgba(60, 60, 67, 0.2); 
      --input-bg: rgba(118, 118, 128, 0.12);
      --glass-bg: rgba(255, 255, 255, 0.85);
      --tab-bg: #E5E5EA;
      --tab-active-bg: #FFFFFF;
      --tab-active-text: #000000;
    }

    [data-theme="dark"] {
      --primary: #0A84FF;
      --bg: #000000;
      --card: #1C1C1E;
      --text: #FFFFFF; 
      --text-sec: #98989D;
      --danger: #FF453A;
      --separator: rgba(84, 84, 88, 0.5);
      --input-bg: rgba(118, 118, 128, 0.24);
      --glass-bg: rgba(30, 30, 30, 0.85);
      --tab-bg: #2C2C2E;
      --tab-active-bg: #636366;
      --tab-active-text: #FFFFFF;
    }
    
    body { 
      background-color: var(--bg); 
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans TC", sans-serif;
      margin: 0; padding-bottom: 120px; color: var(--text);
      transition: background-color 0.3s ease, color 0.3s ease;
      overscroll-behavior-y: none;
      -webkit-user-select: none; user-select: none; -webkit-tap-highlight-color: transparent;
    }
    input, textarea { -webkit-user-select: text; user-select: text; }

    /* Header */
    .sticky-header {
      position: sticky; top: 0; z-index: 100;
      background: var(--glass-bg); backdrop-filter: saturate(180%) blur(20px); -webkit-backdrop-filter: saturate(180%) blur(20px);
      border-bottom: 0.5px solid var(--separator); padding-bottom: 8px; transition: background 0.3s;
    }
    .app-header { background: transparent; padding: 10px 16px 6px 16px; display: flex; align-items: center; justify-content: space-between; }
    .app-title { font-size: 28px; font-weight: 800; color: var(--text); letter-spacing: -0.5px; } 
    .sort-select { border: none; background: var(--input-bg); padding: 6px 12px; border-radius: 14px; font-size: 13px; color: var(--primary); font-weight: 600; outline: none; margin-left: 8px; }
    
    /* Search & Tabs */
    .search-bar { padding: 0 16px 10px 16px; background: transparent; }
    .search-input-wrap { background: var(--input-bg); border-radius: 10px; padding: 8px 10px; display: flex; align-items: center; }
    .search-input-wrap i { color: var(--text-sec); font-size: 14px; }
    .search-input-wrap input { border: none; background: transparent; flex: 1; margin-left: 6px; font-size: 17px; outline: none; color: var(--text); }
    .clear-btn { display: none; color: var(--text-sec); font-size: 16px; cursor: pointer; padding: 4px; margin-left: 8px; }

    .tab-bar { display: flex; overflow-x: auto; white-space: nowrap; padding: 4px 16px 8px 16px; gap: 8px; scrollbar-width: none; }
    .tab-bar::-webkit-scrollbar { display: none; }
    .tab-item { display: inline-block; padding: 7px 16px; border-radius: 18px; font-size: 15px; color: var(--text-sec); font-weight: 600; background: transparent; cursor: pointer; transition: all 0.2s; -webkit-touch-callout: none; }
    .tab-item.active { background: var(--tab-active-bg); color: var(--tab-active-text); box-shadow: 0 2px 8px rgba(0,0,0,0.15); }
    .sortable-ghost { opacity: 0.4; transform: scale(0.95); }

    /* Contact List */
    .contact-list { padding: 16px; }
    .contact-card { 
      background: var(--card); border-radius: 14px; padding: 16px; margin-bottom: 12px; 
      display: flex; align-items: center; box-shadow: 0 1px 2px rgba(0,0,0,0.04); 
      cursor: pointer; position: relative; transition: transform 0.2s, background 0.2s; 
      -webkit-touch-callout: none;
    }
    .contact-card:active { transform: scale(0.98); opacity: 0.8; }
    
    .selection-mode .contact-card { padding-left: 50px; transform: scale(1); }
    .select-checkbox { 
      position: absolute; left: 16px; top: 50%; transform: translateY(-50%);
      width: 22px; height: 22px; border-radius: 50%; border: 1.5px solid var(--text-sec); 
      display: none; align-items: center; justify-content: center; background: var(--card);
    }
    .selection-mode .select-checkbox { display: flex; }
    .select-checkbox.checked { background: var(--primary); border-color: var(--primary); }
    .select-checkbox.checked::after { content: '✓'; color: white; font-size: 14px; font-weight: bold; }

    .avatar { width: 50px; height: 50px; border-radius: 50%; object-fit: cover; margin-right: 14px; background: var(--tab-bg); border: 0.5px solid var(--separator); }
    .info { flex: 1; min-width: 0; }
    .name { font-size: 17px; font-weight: 600; color: var(--text); margin-bottom: 2px; }
    .title { font-size: 14px; color: var(--text-sec); margin-bottom: 1px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .company { font-size: 14px; color: var(--primary); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .tag-badge { font-size: 11px; color: #fff; padding: 3px 8px; border-radius: 6px; margin-left: auto; align-self: flex-start; font-weight: 600; background: var(--text-sec); flex-shrink: 0; }

    /* FAB & Buttons */
    .fab-group { position: fixed; bottom: 30px; right: 20px; display: flex; flex-direction: column; gap: 15px; align-items: flex-end; z-index: 90; transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
    .fab-main { width: 56px; height: 56px; background: var(--primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 24px; box-shadow: 0 4px 12px rgba(0,122,255,0.4); cursor: pointer; transition: transform 0.2s; }
    .fab-main:active { transform: scale(0.9); }
    .fab-menu { display: none; flex-direction: column; gap: 12px; align-items: flex-end; margin-bottom: 10px; }
    .fab-menu.show { display: flex; }
    .fab-item { display: flex; align-items: center; gap: 10px; }
    .fab-btn { width: 44px; height: 44px; border-radius: 50%; background: var(--card); color: var(--text); display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 8px rgba(0,0,0,0.15); cursor: pointer; font-size: 16px; }
    .fab-label { background: var(--glass-bg); color: var(--text); padding: 6px 12px; border-radius: 8px; font-size: 13px; font-weight: 500; backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); }

    .scroll-top-btn {
      position: fixed; bottom: 100px; right: 26px; width: 44px; height: 44px; 
      background: var(--glass-bg); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
      border-radius: 50%; box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      display: flex; align-items: center; justify-content: center; color: var(--primary); font-size: 18px; cursor: pointer;
      opacity: 0; pointer-events: none; transition: all 0.3s; z-index: 80;
    }
    .scroll-top-btn.show { opacity: 1; pointer-events: auto; }

    /* Batch Bar */
    .batch-bar {
      position: fixed; bottom: 0; left: 0; width: 100%; background: var(--glass-bg); backdrop-filter: saturate(180%) blur(20px); -webkit-backdrop-filter: saturate(180%) blur(20px);
      border-top: 0.5px solid var(--separator); padding: 12px 16px; display: flex; justify-content: space-between; align-items: center;
      z-index: 95; transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.32, 0.72, 0, 1);
      box-sizing: border-box; padding-bottom: max(12px, env(safe-area-inset-bottom));
    }
    .batch-bar.active { transform: translateY(0); }
    .batch-left { display: flex; align-items: center; gap: 12px; }
    .btn-cancel-select { width: 28px; height: 28px; border-radius: 50%; background: rgba(118, 118, 128, 0.15); display: flex; align-items: center; justify-content: center; color: var(--text-sec); cursor: pointer; font-size: 14px; }
    .btn-cancel-select:active { background: rgba(118, 118, 128, 0.3); color: var(--text); }
    .batch-actions { display: flex; gap: 12px; }
    .btn-batch { padding: 10px 20px; border-radius: 12px; font-size: 15px; font-weight: 600; cursor: pointer; border: none; transition: opacity 0.2s; position: relative; z-index: 100; }
    .btn-batch-primary { background: var(--primary); color: white; }
    .btn-batch-danger { background: rgba(255, 59, 48, 0.1); color: var(--danger); }

    /* Context Menu */
    .context-menu {
      position: fixed; display: none; flex-direction: column; background: var(--glass-bg); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
      border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.2); z-index: 2000; min-width: 140px; animation: popIn 0.2s;
    }
    @keyframes popIn { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
    .context-item { padding: 12px 16px; font-size: 15px; color: var(--text); display: flex; align-items: center; gap: 10px; border-bottom: 0.5px solid var(--separator); cursor: pointer; }
    .context-item:last-child { border-bottom: none; }

    /* Modals & Forms */
    .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg); z-index: 200; transform: translateY(100%); transition: transform 0.3s; display: flex; flex-direction: column; }
    .modal.active { transform: translateY(0); }
    .modal-header { 
      background: var(--glass-bg); backdrop-filter: blur(20px); padding: 10px 16px; 
      border-bottom: 0.5px solid var(--separator); display: flex; justify-content: space-between; align-items: center; 
      min-height: 44px; box-sizing: border-box; width: 100%; 
    }
    
    .btn-text { background: none; border: none; font-size: 17px; color: var(--primary); cursor: pointer; padding: 4px 8px; font-weight: 400; }
    .btn-text.primary { font-weight: 600; }
    .btn-text.danger { color: var(--danger); }
    .btn-text.cancel { color: var(--text-sec); }
    
    .btn-icon-circle { width: 32px; height: 32px; border-radius: 50%; background: var(--input-bg); color: var(--text); border: none; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 16px; }
    
    .modal-body { flex: 1; overflow-y: auto; padding: 20px 16px; }
    .modal-bottom-sheet { top: auto; bottom: 0; height: auto; border-radius: 16px 16px 0 0; background: var(--card); box-shadow: 0 -4px 30px rgba(0,0,0,0.15); }

    /* Alert Style Modal */
    .modal-alert {
        background: rgba(0,0,0,0.6); backdrop-filter: blur(2px);
        align-items: center; justify-content: center; padding: 20px;
        opacity: 0; pointer-events: none; transition: opacity 0.3s;
        transform: none !important; 
    }
    .modal-alert.active { opacity: 1; pointer-events: auto; }
    .alert-box {
        background: #2C2C2E; 
        width: 100%; max-width: 300px;
        border-radius: 14px; overflow: hidden; 
        box-shadow: 0 10px 30px rgba(0,0,0,0.4);
        color: white;
    }
    [data-theme="dark"] .alert-box { background: #1C1C1E; border: 1px solid #333; }
    .alert-header { padding: 20px 20px 10px 20px; font-size: 16px; font-weight: 600; text-align: center; color: #fff; }
    .alert-body { padding: 0 20px 20px 20px; }
    .alert-input { 
        width: 100%; box-sizing: border-box; padding: 8px 12px; 
        background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); 
        border-radius: 8px; font-size: 16px; color: #fff; outline: none; 
    }
    .alert-footer { display: flex; border-top: 0.5px solid rgba(255,255,255,0.15); }
    .alert-btn { 
        flex: 1; padding: 12px; border: none; background: transparent; 
        font-size: 16px; cursor: pointer; color: #0A84FF; font-weight: 600;
        transition: background 0.2s;
    }
    .alert-btn:active { background: rgba(255,255,255,0.1); }
    .alert-btn.cancel { font-weight: 400; border-right: 0.5px solid rgba(255,255,255,0.15); color: #98989D; }

    /* Color Picker Grid */
    .color-grid {
        display: grid; grid-template-columns: repeat(5, 1fr); gap: 16px; justify-items: center; padding: 10px 0;
    }
    .color-circle {
        width: 44px; height: 44px; border-radius: 50%; cursor: pointer;
        border: 2px solid rgba(0,0,0,0.1); transition: transform 0.2s;
    }
    .color-circle.selected { transform: scale(1.1); border-color: var(--text); box-shadow: 0 0 0 2px var(--bg), 0 0 0 4px var(--primary); }
    .color-circle:active { transform: scale(0.9); }
    
    .color-circle.rainbow {
        background: linear-gradient(135deg, #ff0000, #ffff00, #00ff00, #00ffff, #0000ff, #ff00ff);
        display: flex; align-items: center; justify-content: center;
    }
    .color-circle.rainbow i { color: white; font-size: 18px; text-shadow: 0 1px 2px rgba(0,0,0,0.5); }

    .color-preview-box {
        width: 100%; height: 50px; border-radius: 10px; margin-bottom: 20px;
        display: flex; align-items: center; justify-content: center;
        color: white; font-weight: bold; font-size: 15px;
        box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        border: 1px solid var(--separator);
        transition: background 0.3s;
    }

    /* Img Upload */
    .img-upload-area { margin-bottom: 20px; text-align: center; }
    .img-upload-area img { 
        width: 100%; height: auto; object-fit: cover; 
        background: var(--tab-bg); border-radius: 12px; 
        display: block; margin: 0 auto 16px auto; 
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    .form-section { background: var(--card); border-radius: 10px; padding: 0 16px; margin-bottom: 24px; overflow: hidden; }
    .input-group {
      display: flex; align-items: center; border-bottom: 0.5px solid var(--separator); padding: 12px 0; position: relative;
    }
    .input-group:last-child { border-bottom: none; }
    .section-title { font-size: 13px; color: var(--text-sec); margin-bottom: 8px; margin-left: 16px; text-transform: uppercase; }
    .input-label { width: 80px; font-size: 16px; color: var(--text); flex-shrink: 0; }
    
    .input-field {
      flex: 1; min-width: 0; background: transparent !important; border: none !important; box-shadow: none !important;
      font-size: 16px; color: var(--primary); padding: 4px 8px; outline: none;
    }
    
    .action-box {
      display: flex; align-items: center; margin-left: auto; padding-left: 8px; gap: 16px; flex-shrink: 0;
    }

    .btn-action, .btn-copy {
      font-size: 20px; padding: 4px 8px; cursor: pointer; display: flex; align-items: center; transition: opacity 0.2s;
      color: var(--primary); opacity: 0.6;
    }
    .btn-action:hover, .btn-action:active,
    .btn-copy:hover, .btn-copy:active { opacity: 1; }

    .warning-box { background: rgba(255, 59, 48, 0.1); color: var(--danger); padding: 12px 16px; border-radius: 10px; font-size: 14px; margin-bottom: 20px; display: none; align-items: center; gap: 10px; }
    .toast { position: fixed; top: 60px; left: 50%; transform: translateX(-50%) translateY(-20px); background: var(--glass-bg); backdrop-filter: blur(10px); color: var(--text); padding: 12px 24px; border-radius: 30px; font-weight: 500; opacity: 0; pointer-events: none; transition: all 0.3s; z-index: 300; }
    .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
    .loader { position: fixed; inset: 0; background: var(--glass-bg); backdrop-filter: blur(5px); z-index: 300; display: none; flex-direction: column; align-items: center; justify-content: center; }
    .spinner { border: 3px solid rgba(0,0,0,0.1); border-top: 3px solid var(--primary); border-radius: 50%; width: 32px; height: 32px; animation: spin 0.8s linear infinite; }
    @keyframes spin { 100% { transform: rotate(360deg); } }

    /* Cropper */
    .crop-modal-body { flex: 1; background: #000; position: relative; display: flex; flex-direction: column; height: calc(100% - 50px); }
    .crop-container { flex: 1; position: relative; overflow: hidden; display: flex; align-items: center; justify-content: center; }
    .cropper-bg { background: transparent !important; }
    .scan-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 5; display: none; }
    .scan-line { position: absolute; width: 100%; height: 4px; background: linear-gradient(90deg, rgba(0,122,255,0), rgba(0,122,255,0.9), rgba(0,122,255,0)); box-shadow: 0 0 15px rgba(0, 122, 255, 0.6); top: -10%; }
    .scanning .scan-overlay { display: block; }
    .scanning .scan-line { animation: scanDown 1.5s ease-in-out forwards; }
    @keyframes scanDown { 0% { top: -10%; opacity: 0; } 10% { opacity: 1; } 90% { opacity: 1; } 100% { top: 110%; opacity: 0; } }
    .floating-toolbar { position: absolute; bottom: 40px; left: 50%; transform: translateX(-50%); display: flex; gap: 32px; padding: 16px 36px; background: rgba(44, 44, 46, 0.75); backdrop-filter: saturate(180%) blur(20px); border-radius: 30px; z-index: 10; opacity: 0; transition: opacity 0.3s; }
    .floating-toolbar.show { opacity: 1; }
    .tool-btn { color: white; font-size: 22px; cursor: pointer; }
    .btn-sm { padding: 6px 14px; border-radius: 14px; border: 1px solid var(--separator); background: var(--card); font-size: 13px; color: var(--primary); cursor: pointer; font-weight: 500; }
    .btn-del-img { color: var(--danger); }
  </style>
</head>
<body>

<div class="sticky-header">
  <div class="app-header">
    <div class="header-left">
      <div class="app-title">Meishi Box</div>
      <select class="sort-select" onchange="sortList(this.value)">
        <option value="new">最新</option>
        <option value="name">姓名</option>
        <option value="company">公司</option>
        <option value="tag">標籤</option>
      </select>
    </div>
    <div style="display:flex; gap:8px;">
      <button type="button" class="btn-icon-circle" onclick="toggleTheme()" title="切換模式">
        <i class="fas fa-moon" id="themeIcon"></i>
      </button>
      <button type="button" class="btn-text" id="btnSelect" onclick="toggleSelectionMode()">選取</button>
      <button type="button" class="btn-text primary" onclick="initLoad()" title="更新">
        <i class="fas fa-sync-alt" id="refreshIcon"></i>
      </button>
    </div>
  </div>
  <div class="search-bar">
    <div class="search-input-wrap">
      <i class="fas fa-search"></i>
      <input type="text" id="searchInput" placeholder="搜尋" oninput="toggleSearchClear()" onkeyup="applyFilter()">
      <i class="fas fa-times-circle clear-btn" id="searchClearBtn" onclick="clearSearch()"></i>
    </div>
  </div>
  <div id="tabBar" class="tab-bar"></div>
</div>

<div id="tabContextMenu" class="context-menu">
  <div class="context-item" onclick="openRenameModal()"><i class="fas fa-edit"></i> 編輯名稱</div>
  <div class="context-item" onclick="openColorModal()"><i class="fas fa-palette"></i> 調整顏色</div>
</div>

<div id="contactList" class="contact-list"></div>
<div id="scrollTopBtn" class="scroll-top-btn" onclick="scrollToTop()"><i class="fas fa-arrow-up"></i></div>

<div class="fab-group" id="fabGroup">
  <div class="fab-menu" id="fabMenu">
    <div class="fab-item" onclick="openManualAdd()"><span class="fab-label">手動新增</span><div class="fab-btn"><i class="fas fa-pen"></i></div></div>
    <div class="fab-item" onclick="triggerFile('upload')"><span class="fab-label">上傳圖片</span><div class="fab-btn"><i class="fas fa-image"></i></div></div>
    <div class="fab-item" onclick="triggerFile('camera')"><span class="fab-label">相機拍照</span><div class="fab-btn"><i class="fas fa-camera"></i></div></div>
  </div>
  <div class="fab-main" onclick="toggleFab()"><i class="fas fa-plus"></i></div>
</div>

<div class="batch-bar" id="batchBar">
  <div class="batch-left">
    <div class="btn-cancel-select" onclick="toggleSelectionMode()" title="取消"><i class="fas fa-times"></i></div>
    <div class="batch-info" id="batchInfo">已選取 0 筆</div>
  </div>
  <div class="batch-actions">
    <button type="button" class="btn-batch btn-batch-danger" onclick="event.stopPropagation(); executeBatchDelete()">刪除</button>
    <button type="button" class="btn-batch btn-batch-primary" onclick="event.stopPropagation(); openBatchTagModal()">標籤</button>
  </div>
</div>

<input type="file" id="fileInput" accept="image/*" style="display:none" onchange="handleFileSelect(this)">
<input type="file" id="cameraInput" accept="image/*" capture="environment" style="display:none" onchange="handleFileSelect(this)">

<div id="cropModal" class="modal">
  <div class="modal-header" style="background: rgba(0,0,0,0.4); color: white; border: none; position: absolute; width: 100%; top: 0; left: 0; z-index: 10;">
    <button type="button" class="btn-text" style="color: rgba(255,255,255,0.8);" onclick="closeModal('cropModal')">取消</button>
    <div class="modal-title" style="color:white">裁切名片</div>
    <button type="button" class="btn-text" style="color: white; font-weight:600;" onclick="confirmCrop()">確認</button>
  </div>

  <div class="crop-modal-body" id="cropModalBody">
    <div class="crop-container">
        <img id="cropImage" style="max-width: 100%; opacity: 0; transition: opacity 0.3s;">
        <div class="scan-overlay"><div class="scan-line"></div></div>
    </div>
    <div class="floating-toolbar" id="cropToolbar">
        <i class="fas fa-undo tool-btn" onclick="cropper.rotate(-90)"></i>
        <i class="fas fa-sync tool-btn" onclick="cropper.reset()"></i>
        <i class="fas fa-redo tool-btn" onclick="cropper.rotate(90)"></i>
    </div>
  </div>
</div>

<div id="detailModal" class="modal">
  <div class="modal-header">
    <button type="button" class="btn-text cancel" onclick="closeModal('detailModal')">取消</button>
    <div class="modal-title" id="formTitle">詳細資料</div>
    <div style="display:flex;">
        <button type="button" class="btn-text" onclick="copyContactInfo()" title="複製"><i class="fas fa-copy"></i></button>
        <button type="button" class="btn-text primary" onclick="saveContact()">儲存</button>
    </div>
  </div>
  <div class="modal-body">
    <div class="img-upload-area">
      <img id="previewImg" src="" style="width: 100%; height: auto; max-height: 300px; object-fit: contain; background: var(--tab-bg); border-radius: 12px; display:block; margin: 0 auto 12px auto;">
      <div class="img-controls">
        <button type="button" class="btn-sm" onclick="triggerLocalUpload()">更換照片</button>
        <button type="button" class="btn-sm btn-del-img" onclick="removePreviewImage()">移除</button>
      </div>
    </div>
    <input type="file" id="localImgInput" accept="image/*" style="display:none" onchange="handleLocalImage(this)">
    <input type="hidden" id="rowIndex"><input type="hidden" id="imgUrlHidden">

    <div class="section-title">基本資料</div>
    <div class="form-section">
      <div class="input-group">
        <label class="input-label">姓名</label>
        <input type="text" id="inputName" class="input-field" placeholder="必填">
        <div class="action-box"><i class="fas fa-copy btn-copy" onclick="copyField('inputName')"></i></div>
      </div>
      <div class="input-group">
        <label class="input-label">職稱</label>
        <input type="text" id="inputTitle" class="input-field" placeholder="職稱">
        <div class="action-box"><i class="fas fa-copy btn-copy" onclick="copyField('inputTitle')"></i></div>
      </div>
      <div class="input-group">
        <label class="input-label">公司</label>
        <input type="text" id="inputCompany" class="input-field" placeholder="公司名稱">
        <div class="action-box"><i class="fas fa-copy btn-copy" onclick="copyField('inputCompany')"></i></div>
      </div>
    </div>

    <div class="section-title">聯絡方式</div>
    <div class="form-section">
      <div class="input-group">
        <label class="input-label">手機</label>
        <input type="text" id="inputPhone" class="input-field" placeholder="手機號碼">
        <div class="action-box">
          <i class="fas fa-mobile-alt btn-action" onclick="makeCall('inputPhone')"></i>
          <i class="fas fa-copy btn-copy" onclick="copyField('inputPhone')"></i>
        </div>
      </div>
      <div class="input-group">
        <label class="input-label">電話</label>
        <input type="text" id="inputTelCompany" class="input-field" placeholder="公司電話">
        <div class="action-box">
          <i class="fas fa-tty btn-action" onclick="makeCall('inputTelCompany')"></i>
          <i class="fas fa-copy btn-copy" onclick="copyField('inputTelCompany')"></i>
        </div>
      </div>
      <div class="input-group">
        <label class="input-label">信箱</label>
        <input type="email" id="inputEmail" class="input-field" placeholder="電子信箱">
        <div class="action-box"><i class="fas fa-copy btn-copy" onclick="copyField('inputEmail')"></i></div>
      </div>
      <div class="input-group">
        <label class="input-label">網址</label>
        <input type="text" id="inputWebsite" class="input-field" placeholder="網站">
        <div class="action-box"><i class="fas fa-copy btn-copy" onclick="copyField('inputWebsite')"></i></div>
      </div>
    </div>
    
    <div class="section-title">公司資料</div>
    <div class="form-section">
      <div class="input-group">
        <label class="input-label">統編</label>
        <input type="text" id="inputTaxId" class="input-field" placeholder="統一編號">
        <div class="action-box"><i class="fas fa-copy btn-copy" onclick="copyField('inputTaxId')"></i></div>
      </div>
      <div class="input-group">
        <label class="input-label">地址</label>
        <input type="text" id="inputAddress" class="input-field" placeholder="地址">
        <div class="action-box">
          <i class="fas fa-location-arrow btn-action" onclick="openMap()"></i>
          <i class="fas fa-copy btn-copy" onclick="copyField('inputAddress')"></i>
        </div>
      </div>
    </div>
    
    <div class="section-title">其他</div>
    <div class="form-section">
      <div class="input-group">
        <label class="input-label">標籤</label>
        <input type="text" id="inputTag" class="input-field" placeholder="選擇或輸入" list="tagOptions">
        <datalist id="tagOptions"></datalist>
      </div>
      <div class="input-group" style="border:none;">
          <label class="input-label">備註</label>
          <input type="text" id="inputNote" class="input-field" placeholder="備註...">
      </div>
    </div>
  </div>
</div>

<div id="batchTagModal" class="modal modal-bottom-sheet">
  <div class="modal-header" style="border-radius: 16px 16px 0 0; border-bottom: none;">
    <button type="button" class="btn-text" onclick="closeModal('batchTagModal')">取消</button>
    <div class="modal-title">批次設定</div>
    <button type="button" class="btn-text primary" id="btnConfirmBatchTag" onclick="confirmBatchTag()">完成</button>
  </div>
  <div class="modal-body" style="padding: 20px;">
    <div id="batchWarning" class="warning-box">
      <i class="fas fa-exclamation-circle"></i>
      <div>注意：所選資料中包含已設定標籤的項目。</div>
    </div>
    <div class="form-section">
        <div class="input-group" style="border:none;">
            <label class="input-label" style="width:60px;">標籤</label>
            <input type="text" id="batchInputTag" class="input-field" placeholder="輸入標籤名稱" list="tagOptions">
        </div>
    </div>
    <button type="button" class="btn-text danger" style="width: 100%; text-align: center; margin-top: 10px;" onclick="confirmBatchTag(true)">移除所選標籤</button>
  </div>
</div>

<div id="renameModal" class="modal modal-alert">
    <div class="alert-box">
        <div class="alert-header">編輯標籤名稱</div>
        <div class="alert-body">
            <input type="text" id="renameInput" class="alert-input" placeholder="請輸入新名稱">
        </div>
        <div class="alert-footer">
            <button type="button" class="alert-btn cancel" onclick="closeModal('renameModal')">取消</button>
            <button type="button" class="alert-btn" onclick="confirmRename()">確定</button>
        </div>
    </div>
</div>

<div id="colorModal" class="modal modal-bottom-sheet">
  <div class="modal-header" style="border-radius: 16px 16px 0 0; border-bottom: none;">
    <button type="button" class="btn-text" onclick="closeModal('colorModal')">取消</button>
    <div class="modal-title">選擇顏色</div>
    <button type="button" class="btn-text primary" onclick="saveSelectedColor()">確定</button>
  </div>
  <div class="modal-body" style="padding: 24px;">
    <div id="colorPreview" class="color-preview-box" style="background:var(--primary);">預覽顏色</div>
    <div class="color-grid">
        <div class="color-circle" style="background:#FF3B30" onclick="selectColor('#FF3B30', this)"></div>
        <div class="color-circle" style="background:#FF9500" onclick="selectColor('#FF9500', this)"></div>
        <div class="color-circle" style="background:#FFCC00" onclick="selectColor('#FFCC00', this)"></div>
        <div class="color-circle" style="background:#34C759" onclick="selectColor('#34C759', this)"></div>
        <div class="color-circle" style="background:#007AFF" onclick="selectColor('#007AFF', this)"></div>
        <div class="color-circle" style="background:#5856D6" onclick="selectColor('#5856D6', this)"></div>
        <div class="color-circle" style="background:#AF52DE" onclick="selectColor('#AF52DE', this)"></div>
        <div class="color-circle" style="background:#8E8E93" onclick="selectColor('#8E8E93', this)"></div>
        <div class="color-circle" style="background:#000000" onclick="selectColor('#000000', this)"></div>
        <div class="color-circle rainbow" style="position: relative;">
          <i class="fas fa-plus"></i>
          <input type="color" onchange="selectColor(this.value, this.parentNode)" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer; border: none; padding: 0;">
        </div>
    </div>
  </div>
</div>

<div id="loader" class="loader">
  <div class="spinner"></div>
  <p id="loadingText" style="margin-top:15px; color:var(--text-sec);">處理中...</p>
</div>
<div id="toast" class="toast">訊息</div>

<script>
  // 【請在這裡貼上您的 Google Apps Script 部署網址】
  const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwnwX2OE_lOYJdLb82Exr44HFVdrSTggBZ-b6NNpyK60FIOUFVSL2KSGt8gGdtq7SnK/exec"; 

  // --- API 呼叫包裝函式 (GitHub 專用) ---
  async function callBackend(action, data = {}) {
    try {
        const payload = JSON.stringify({ 
            action: action, 
            appSecret: "MeishiBox_2024_Secret", // 必須跟後端 Code.gs 設定的密碼一樣
            ...data 
        });

        // 使用 text/plain 避開 CORS 錯誤
        const response = await fetch(SCRIPT_URL, {
            method: "POST",
            headers: { "Content-Type": "text/plain;charset=utf-8" },
            body: payload
        });

        const result = await response.json();
        return result;
    } catch (e) {
        console.error("API Call Failed:", e);
        return { status: 'error', message: '連線失敗: ' + e.toString() };
    }
  }

  let allContacts = [];
  let cropper = null;
  let currentTab = '全部';
  let isSelectionMode = false; 
  let selectedRows = new Set(); 
  let savedTabOrder = JSON.parse(localStorage.getItem('tabOrder_v1')) || [];
  let customTagColors = JSON.parse(localStorage.getItem('tag_colors')) || {};
  let pressTimer;
  let isLongPressTriggered = false;
  let lastTouchTime = 0;
  let tabPressTimer; 
  let selectedTabForAction = null;
  let pendingColor = null;

  const defaultAvatar = "https://cdn-icons-png.flaticon.com/512/847/847969.png"; 
  const formPlaceholder = "https://cdn-icons-png.flaticon.com/512/847/847969.png";

  window.onload = function() {
    if (typeof loadFromUrlHash === 'function') {
      loadFromUrlHash();
    }
    // initTheme 已由 head script 取代
    initLoad();
    initSwipeBack(); 
    
    var closeMenuHandler = function(e) {
      if (!e.target.closest('.context-menu')) {
        var menu = document.getElementById('tabContextMenu');
        if (menu && menu.style.display !== 'none') {
          menu.style.display = 'none';
        }
      }
    };
    document.addEventListener('mousedown', closeMenuHandler);
    document.addEventListener('touchstart', closeMenuHandler);
  };
  
  function startPress(e, rowIndex) {
    if (e.type === 'touchstart') {
      lastTouchTime = Date.now();
    } else if (e.type === 'mousedown') {
      if (Date.now() - lastTouchTime < 800) return; 
    }
    isLongPressTriggered = false;
    pressTimer = setTimeout(() => {
        triggerSelection(rowIndex);
    }, 600);
  }
  function cancelPress() { clearTimeout(pressTimer); }
  function handleRightClick(rowIndex) { clearTimeout(pressTimer); triggerSelection(rowIndex); }

  function triggerSelection(rowIndex) {
    isLongPressTriggered = true; 
    if (navigator.vibrate) navigator.vibrate(50);
    if (!isSelectionMode) toggleSelectionMode(true);
    const strRow = rowIndex.toString();
    if (!selectedRows.has(strRow)) selectedRows.add(strRow);
    updateBatchUI();
    renderListHTML(); 
  }

  function handleCardClick(jsonStr, rowIndex) {
    if (isLongPressTriggered) { isLongPressTriggered = false; return; }
    if (isSelectionMode) {
      const strRow = rowIndex.toString();
      if (selectedRows.has(strRow)) selectedRows.delete(strRow); else selectedRows.add(strRow);
      updateBatchUI(); renderListHTML();
    } else {
      const item = JSON.parse(decodeURIComponent(jsonStr));
      openDetailModal(item, item.imageUrl, null);
    }
  }

  // --- Tab Logic ---
  function startTabPress(e, tag) {
    if (tag === '全部' || tag === '未分類') return;
    if (navigator.vibrate) navigator.vibrate(50);
    tabPressTimer = setTimeout(() => { showTabContextMenu(e, tag); }, 600);
  }
  function cancelTabPress() { clearTimeout(tabPressTimer); }

  function showTabContextMenu(e, tag) {
    if (tag === '全部' || tag === '未分類') return; 
    e.preventDefault();
    selectedTabForAction = tag;
    pendingColor = customTagColors[tag] || '#007AFF';
    
    const menu = document.getElementById('tabContextMenu');
    let x = e.clientX || (e.touches && e.touches[0].clientX);
    let y = e.clientY || (e.touches && e.touches[0].clientY);
    if (x + 150 > window.innerWidth) x = window.innerWidth - 160;
    menu.style.left = x + 'px';
    menu.style.top = y + 'px';
    menu.style.display = 'flex';
  }

  function openRenameModal() {
    document.getElementById('tabContextMenu').style.display = 'none';
    document.getElementById('renameInput').value = selectedTabForAction;
    document.getElementById('renameModal').classList.add('active');
    setTimeout(() => document.getElementById('renameInput').focus(), 100);
  }

  function confirmRename() {
    const oldName = selectedTabForAction;
    const newName = document.getElementById('renameInput').value.trim();
    closeModal('renameModal');

    if (newName && newName !== oldName) {
      showLoading('更新中...');
      allContacts.forEach(c => { if(c.tag === oldName) c.tag = newName; });
      
      // 先處理顏色同步 (如果有的話)
      if(customTagColors[oldName]) {
        customTagColors[newName] = customTagColors[oldName];
        delete customTagColors[oldName];
        localStorage.setItem('tag_colors', JSON.stringify(customTagColors));
        callBackend('saveCloudSettings', { settings: { tagColors: customTagColors } });
      }

      // 再處理後端改名
      callBackend('batchRenameTag', { oldTag: oldName, newTag: newName }).then(res => {
        hideLoading();
        if(res.status === 'success') {
          renderTabs();
          if(currentTab === oldName) switchTab(newName); else applyFilter();
          showToast('更名成功');
        } else {
          alert(res.message);
        }
      });
    }
  }

  function openColorModal() {
    document.getElementById('tabContextMenu').style.display = 'none';
    document.getElementById('colorPreview').style.background = pendingColor;
    document.querySelectorAll('.color-circle').forEach(el => el.classList.remove('selected'));
    document.getElementById('colorModal').classList.add('active');
  }

  function selectColor(color, element) {
    pendingColor = color;
    document.getElementById('colorPreview').style.background = color;
    document.querySelectorAll('.color-circle').forEach(el => el.classList.remove('selected'));
    if(element) element.classList.add('selected');
  }

  function saveSelectedColor() {
    if (selectedTabForAction && pendingColor) {
      customTagColors[selectedTabForAction] = pendingColor;
      localStorage.setItem('tag_colors', JSON.stringify(customTagColors));
      applyFilter(); 
      showToast('顏色已更新');
      closeModal('colorModal');
      callBackend('saveCloudSettings', { settings: { tagColors: customTagColors } });
    }
  }

  // --- Core Functions ---
  function initLoad() {
    if(isSelectionMode) toggleSelectionMode(false);
    const icon = document.getElementById('refreshIcon');
    if(icon) icon.classList.add('fa-spin');

    // 1. 取得設定
    callBackend('getCloudSettings').then(settings => {
      if (settings && settings.theme === 'dark') {
        document.documentElement.setAttribute('data-theme', 'dark');
        const tIcon = document.getElementById('themeIcon');
        if(tIcon) { tIcon.classList.remove('fa-moon'); tIcon.classList.add('fa-sun'); }
      }
      if (settings && settings.tabOrder && settings.tabOrder.length > 0) {
        savedTabOrder = settings.tabOrder;
        localStorage.setItem('tabOrder_v1', JSON.stringify(savedTabOrder));
      }
      if (settings && settings.tagColors) {
        customTagColors = settings.tagColors;
        localStorage.setItem('tag_colors', JSON.stringify(customTagColors));
      }
      
      // 2. 取得聯絡人
      return callBackend('getContactList');
    }).then(renderList);
  }

  function renderList(res) {
    if(!res || res.status !== 'success') { 
        hideLoading(); 
        if(res && res.message) alert(res.message);
        return; 
    }
    allContacts = res.data;
    renderTabs(); 
    applyFilter();
    hideLoading(); 
  }

  function applyFilter() {
    const q = document.getElementById('searchInput').value.toLowerCase();
    toggleSearchClear(); 
    const filtered = allContacts.filter(item => {
      let matchTag = false;
      if (currentTab === '全部') matchTag = true;
      else if (currentTab === '未分類') matchTag = !item.tag || item.tag.trim() === '';
      else matchTag = (item.tag === currentTab);
      const str = (item.name + item.company + item.title + item.phone + item.tax_id + (item.tag||'')).toLowerCase();
      return matchTag && str.includes(q);
    });
    generateHtml(filtered);
  }

  function renderListHTML() { applyFilter(); }

  function generateHtml(data) {
    const listDiv = document.getElementById('contactList');
    if(data.length === 0) { listDiv.innerHTML = '<div style="text-align:center;padding:60px 20px;color:var(--text-sec);font-size:14px;">暫無符合的資料</div>'; return; }
    
    let html = '';
    data.forEach(item => {
      let img = (item.imageUrl && item.imageUrl.startsWith('http')) ? item.imageUrl : defaultAvatar;
      const jsonStr = encodeURIComponent(JSON.stringify(item));
      let tagLabel = '';
      if(item.tag) {
          const bg = stringToColor(item.tag);
          tagLabel = `<span class="tag-badge" style="background:${bg}">${item.tag}</span>`;
      }
      const isChecked = selectedRows.has(item.rowIndex.toString()) ? 'checked' : '';

      html += `
        <div class="contact-card" 
             oncontextmenu="handleRightClick('${item.rowIndex}'); return false;"
             ontouchstart="startPress(event, '${item.rowIndex}')" 
             ontouchend="cancelPress()" 
             ontouchmove="cancelPress()" 
             onmousedown="startPress(event, '${item.rowIndex}')" 
             onmouseup="cancelPress()" 
             onmouseleave="cancelPress()"
             onclick="handleCardClick('${jsonStr}', '${item.rowIndex}')">
          <div class="select-checkbox ${isChecked}" id="chk-${item.rowIndex}"></div>
          <img src="${img}" class="avatar">
          <div class="info">
            <div style="display:flex; justify-content:space-between; align-items:flex-start;">
               <div class="name">${item.name || '未命名'}</div>
               ${tagLabel}
            </div>
            <div class="title">${item.title || ''}</div>
            <div class="company">${item.company || ''}</div>
          </div>
        </div>`;
    });
    listDiv.innerHTML = html;
  }

  function toggleSelectionMode(forceState) {
    if (typeof forceState !== 'undefined') isSelectionMode = forceState;
    else isSelectionMode = !isSelectionMode;

    const btnText = document.getElementById('btnSelect');
    const contactList = document.getElementById('contactList');
    const batchBar = document.getElementById('batchBar');
    const fabGroup = document.getElementById('fabGroup');

    if(isSelectionMode) {
      btnText.innerText = "完成";
      btnText.classList.add('primary');
      contactList.classList.add('selection-mode');
      batchBar.classList.add('active');
      fabGroup.style.transform = 'translateY(200%)'; 
    } else {
      btnText.innerText = "選取";
      btnText.classList.remove('primary');
      contactList.classList.remove('selection-mode');
      batchBar.classList.remove('active');
      fabGroup.style.transform = 'translateY(0)';
      selectedRows.clear();
      applyFilter(); 
    }
    updateBatchUI();
  }

  function updateBatchUI() { document.getElementById('batchInfo').innerText = `已選取 ${selectedRows.size} 筆`; }

  function renderTabs() {
    const rawTabs = new Set(['全部', '未分類']);
    allContacts.forEach(item => { if(item.tag && item.tag.trim() !== '') rawTabs.add(item.tag.trim()); });
    let tabsArray = Array.from(rawTabs);
    if (savedTabOrder.length > 0) {
      tabsArray.sort((a, b) => {
        const indexA = savedTabOrder.indexOf(a); const indexB = savedTabOrder.indexOf(b);
        if (indexA !== -1 && indexB !== -1) return indexA - indexB;
        if (a === '全部') return -1; if (b === '全部') return 1; if (a === '未分類') return -1; if (b === '未分類') return 1;
        if (indexA !== -1) return -1; if (indexB !== -1) return 1; return 0;
      });
    } else {
        tabsArray.sort((a, b) => { if (a === '全部') return -1; if (b === '全部') return 1; if (a === '未分類') return -1; if (b === '未分類') return 1; return 0; });
    }

    const tabBar = document.getElementById('tabBar');
    const tagOptions = document.getElementById('tagOptions');
    let tabHtml = ''; let optionsHtml = '';

    tabsArray.forEach(tag => {
      const activeClass = (tag === currentTab) ? 'active' : '';
      tabHtml += `<div class="tab-item ${activeClass}" data-id="${tag}" 
                       onclick="switchTab('${tag}')"
                       oncontextmenu="showTabContextMenu(event, '${tag}'); return false;"
                       ontouchstart="startTabPress(event, '${tag}')"
                       ontouchend="cancelTabPress()"
                       ontouchmove="cancelTabPress()">${tag}</div>`;
      if(tag !== '全部' && tag !== '未分類') optionsHtml += `<option value="${tag}">`;
    });
    tabBar.innerHTML = tabHtml;
    tagOptions.innerHTML = optionsHtml;

    new Sortable(tabBar, {
      animation: 150, delay: 200, touchStartThreshold: 10, delayOnTouchOnly: false, ghostClass: 'sortable-ghost',
      onEnd: function (evt) {
        const newOrder = Array.from(tabBar.querySelectorAll('.tab-item')).map(el => el.getAttribute('data-id'));
        localStorage.setItem('tabOrder_v1', JSON.stringify(newOrder));
        savedTabOrder = newOrder;
        updateUrlHash();
        callBackend('saveCloudSettings', { settings: { tabOrder: newOrder } });
      }
    });
  }

  function switchTab(tag) {
    currentTab = tag;
    document.querySelectorAll('.tab-item').forEach(el => {
      if(el.getAttribute('data-id') === tag) el.classList.add('active'); else el.classList.remove('active');
    });
    applyFilter();
  }

  function stringToColor(str) {
    if (customTagColors[str]) return customTagColors[str];
    let hash = 0; for (let i = 0; i < str.length; i++) { hash = str.charCodeAt(i) + ((hash << 5) - hash); }
    const hue = Math.abs(hash) % 360; return `hsl(${hue}, 60%, 50%)`; 
  }

  function makeCall(inputId) {
    const val = document.getElementById(inputId).value;
    if (val) window.open('tel:' + val, '_self'); else showToast('無電話號碼');
  }

  function openMap() {
    const val = document.getElementById('inputAddress').value;
    if (val) window.open('https://www.google.com/maps/search/?api=1&query=' + encodeURIComponent(val), '_blank'); else showToast('無地址資料');
  }

  function copyContactInfo() {
    const name = document.getElementById('inputName').value;
    const title = document.getElementById('inputTitle').value;
    const company = document.getElementById('inputCompany').value;
    const mobile = document.getElementById('inputPhone').value;
    const tel = document.getElementById('inputTelCompany').value;
    const email = document.getElementById('inputEmail').value;
    const address = document.getElementById('inputAddress').value;
    const taxId = document.getElementById('inputTaxId').value;
    const note = document.getElementById('inputNote').value;
    let text = `【名片資訊】\n`;
    if(name) text += `姓名：${name} ${title ? '('+title+')' : ''}\n`;
    if(company) text += `公司：${company}\n`;
    if(mobile) text += `手機：${mobile}\n`;
    if(tel) text += `電話：${tel}\n`;
    if(email) text += `信箱：${email}\n`;
    if(address) text += `地址：${address}\n`;
    if(taxId) text += `統編：${taxId}\n`;
    if(note) text += `備註：${note}\n`;
    navigator.clipboard.writeText(text).then(() => { showToast('已複製'); }).catch(() => { showToast('複製失敗'); });
  }

  function copyField(inputId) {
    var val = document.getElementById(inputId).value;
    if (val) {
      navigator.clipboard.writeText(val).then(function() { showToast('已複製'); }).catch(function() { showToast('複製失敗'); });
    } else { showToast('無內容'); }
  }

  function toggleSearchClear() {
    const val = document.getElementById('searchInput').value;
    document.getElementById('searchClearBtn').style.display = val.length > 0 ? 'block' : 'none';
  }
  function clearSearch() { document.getElementById('searchInput').value = ''; toggleSearchClear(); applyFilter(); }

  function toggleTheme() {
    const currentTheme = document.documentElement.getAttribute('data-theme');
    const icon = document.getElementById('themeIcon');
    let newTheme = 'light';

    if (currentTheme === 'dark') { 
      document.documentElement.removeAttribute('data-theme'); 
      newTheme = 'light';
      icon.classList.remove('fa-sun'); 
      icon.classList.add('fa-moon'); 
    } else { 
      document.documentElement.setAttribute('data-theme', 'dark'); 
      newTheme = 'dark';
      icon.classList.remove('fa-moon'); 
      icon.classList.add('fa-sun'); 
    }
    
    localStorage.setItem('app_theme', newTheme);
    updateUrlHash(); 
    callBackend('saveCloudSettings', { settings: { theme: newTheme } });
  }

  function showLoading(txt) { document.getElementById('loadingText').innerText = txt || '處理中...'; document.getElementById('loader').style.display = 'flex'; }
  function hideLoading() { document.getElementById('loader').style.display = 'none'; const icon = document.getElementById('refreshIcon'); if(icon) icon.classList.remove('fa-spin'); }
  function showToast(msg) { const el = document.getElementById('toast'); el.innerText = msg; el.classList.add('show'); setTimeout(() => { el.classList.remove('show'); }, 2000); }

  function openBatchTagModal() {
    if(selectedRows.size === 0) { showToast('請先選取資料'); return; }
    const inputTag = document.getElementById('batchInputTag');
    const warningBox = document.getElementById('batchWarning');
    const btnConfirm = document.getElementById('btnConfirmBatchTag');
    inputTag.value = '';
    let hasExistingTags = false;
    selectedRows.forEach(rowStr => { const contact = allContacts.find(c => c.rowIndex == rowStr); if (contact && contact.tag && contact.tag.trim() !== '') hasExistingTags = true; });
    if (hasExistingTags) { warningBox.style.display = 'flex'; inputTag.disabled = true; inputTag.placeholder = "請先移除舊標籤"; btnConfirm.disabled = true; }
    else { warningBox.style.display = 'none'; inputTag.disabled = false; inputTag.placeholder = "輸入標籤"; btnConfirm.disabled = false; }
    document.getElementById('batchTagModal').classList.add('active');
  }
  
  function confirmBatchTag(isDelete = false) {
    let newTag = document.getElementById('batchInputTag').value;
    if (isDelete === true) { if (!confirm('確定要移除這些聯絡人的標籤嗎？')) return; newTag = ""; }
    else { if (document.getElementById('batchInputTag').disabled) return; if (!newTag) { showToast('請輸入標籤'); return; } }
    closeModal('batchTagModal'); showLoading();
    const rows = Array.from(selectedRows);
    
    callBackend('batchUpdateTags', { rowIndices: rows, newTag: newTag }).then(res => {
      hideLoading();
      if(res.status === 'success') { showToast(res.message); toggleSelectionMode(false); initLoad(); } else { alert(res.message); }
    });
  }

  function executeBatchDelete() {
    if(selectedRows.size === 0) { showToast('請先選取資料'); return; }
    if(!confirm(`確定要刪除這 ${selectedRows.size} 筆資料嗎？`)) return;
    showLoading(); const rows = Array.from(selectedRows);
    
    callBackend('batchDeleteContacts', { rowIndices: rows }).then(res => {
      hideLoading();
      if(res.status === 'success') { showToast(res.message); toggleSelectionMode(false); initLoad(); } else { alert(res.message); }
    });
  }

  function openManualAdd() { toggleFab(); openDetailModal({}, '', formPlaceholder); }
  function triggerLocalUpload() { document.getElementById('localImgInput').click(); }
  function toggleFab() { document.getElementById('fabMenu').classList.toggle('show'); document.querySelector('.fab-main i').classList.toggle('fa-plus'); document.querySelector('.fab-main i').classList.toggle('fa-times'); }
  function triggerFile(type) { toggleFab(); if(type === 'upload') document.getElementById('fileInput').click(); else document.getElementById('cameraInput').click(); }
  function handleFileSelect(input) { if (input.files && input.files[0]) { const file = input.files[0]; const reader = new FileReader(); reader.onload = function(e) { openCropModal(e.target.result); }; reader.readAsDataURL(file); input.value = ''; } }
  
  function openCropModal(imgSrc) {
    const img = document.getElementById('cropImage');
    const modalBody = document.getElementById('cropModalBody');
    const toolbar = document.getElementById('cropToolbar');
    img.src = imgSrc; img.style.opacity = '0'; toolbar.classList.remove('show');
    document.getElementById('cropModal').classList.add('active');
    if (cropper) cropper.destroy();
    modalBody.classList.add('scanning');
    setTimeout(() => { modalBody.classList.remove('scanning'); img.style.opacity = '1'; toolbar.classList.add('show'); cropper = new Cropper(img, { viewMode: 1, dragMode: 'move', autoCropArea: 0.8, restore: false, guides: true, center: true, highlight: false, cropBoxMovable: true, cropBoxResizable: true, toggleDragModeOnDblclick: false }); }, 1200);
  }
  
  function confirmCrop() { 
    if (!cropper) return; 
    showLoading(); 
    const croppedCanvas = cropper.getCroppedCanvas({ width: 800 }); 
    const base64Data = croppedCanvas.toDataURL('image/jpeg').split(',')[1]; 
    closeModal('cropModal'); 
    document.getElementById('cropToolbar').classList.remove('show'); 
    document.getElementById('cropImage').style.opacity = '0'; 
    
    callBackend('processBusinessCard', { base64Data: base64Data, fileName: 'cropped_card.jpg' }).then(res => {
        if(res.status === 'success') { 
            openDetailModal(res.data, res.imageUrl, croppedCanvas.toDataURL('image/jpeg')); 
            hideLoading(); 
        } else { 
            hideLoading(); 
            alert('分析失敗: ' + res.message); 
        } 
    });
  }

  function handleLocalImage(input) { if (input.files && input.files[0]) { const file = input.files[0]; const img = document.createElement('img'); const url = URL.createObjectURL(file); img.onload = function() { const MAX_WIDTH = 800; let width = img.width; let height = img.height; if (width > MAX_WIDTH) { height *= MAX_WIDTH / width; width = MAX_WIDTH; } const canvas = document.createElement('canvas'); canvas.width = width; canvas.height = height; const ctx = canvas.getContext('2d'); ctx.drawImage(img, 0, 0, width, height); const compressedDataUrl = canvas.toDataURL('image/jpeg', 0.7); document.getElementById('previewImg').src = compressedDataUrl; document.getElementById('imgUrlHidden').value = compressedDataUrl; URL.revokeObjectURL(url); }; img.src = url; } }
  function removePreviewImage() { document.getElementById('previewImg').src = formPlaceholder; document.getElementById('imgUrlHidden').value = ""; }
  
  function openDetailModal(data, driveUrl, localBase64) {
    document.getElementById('formTitle').innerText = data.rowIndex ? '編輯資料' : '新增名片'; document.getElementById('rowIndex').value = data.rowIndex || ''; document.getElementById('imgUrlHidden').value = driveUrl || ''; document.getElementById('previewImg').src = localBase64 ? localBase64 : (driveUrl && driveUrl.startsWith('http') ? driveUrl : formPlaceholder);
    document.getElementById('inputName').value = data.name || ''; document.getElementById('inputTitle').value = data.title || ''; document.getElementById('inputCompany').value = data.company || ''; document.getElementById('inputPhone').value = data.mobile || data.phone || ''; document.getElementById('inputTelCompany').value = data.tel_company || ''; document.getElementById('inputEmail').value = data.email || ''; document.getElementById('inputWebsite').value = data.website || ''; document.getElementById('inputAddress').value = data.address || ''; document.getElementById('inputTaxId').value = data.tax_id || ''; document.getElementById('inputNote').value = data.note || ''; document.getElementById('inputTag').value = data.tag || '';
    document.getElementById('detailModal').classList.add('active');
  }

  function saveContact() {
    const formData = { rowIndex: document.getElementById('rowIndex').value, name: document.getElementById('inputName').value, title: document.getElementById('inputTitle').value, company: document.getElementById('inputCompany').value, phone: document.getElementById('inputPhone').value, tel_company: document.getElementById('inputTelCompany').value, email: document.getElementById('inputEmail').value, address: document.getElementById('inputAddress').value, website: document.getElementById('inputWebsite').value, tax_id: document.getElementById('inputTaxId').value, note: document.getElementById('inputNote').value, tag: document.getElementById('inputTag').value, imageUrl: document.getElementById('imgUrlHidden').value };
    if (!formData.name) { showToast('請輸入姓名'); return; } 
    showLoading();
    
    // 區分新增或編輯
    const actionName = formData.rowIndex ? 'updateContactInSheet' : 'saveContactToSheet';
    callBackend(actionName, { formData: formData }).then(res => {
        hideLoading(); 
        if(res.status === 'success') { 
            showToast(res.message); 
            closeModal('detailModal'); 
            initLoad(); 
        } else { 
            alert(res.message); 
        } 
    });
  }
  
  function closeModal(id) { document.getElementById(id).classList.remove('active'); }

  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
      var tabMenu = document.getElementById('tabContextMenu');
      if (tabMenu && tabMenu.style.display !== 'none') {
        tabMenu.style.display = 'none';
        return;
      }
      if (document.getElementById('cropModal').classList.contains('active')) { closeModal('cropModal'); return; }
      if (document.getElementById('detailModal').classList.contains('active')) { closeModal('detailModal'); return; }
      if (document.getElementById('batchTagModal').classList.contains('active')) { closeModal('batchTagModal'); return; }
      if (document.getElementById('renameModal').classList.contains('active')) { closeModal('renameModal'); return; }
      if (document.getElementById('colorModal').classList.contains('active')) { closeModal('colorModal'); return; }

      var searchInput = document.getElementById('searchInput');
      if (searchInput && searchInput.value !== '') {
        clearSearch(); 
        searchInput.blur();
        return;
      }
      if (isSelectionMode) toggleSelectionMode(false);
    }
  });

  function sortList(type) { let sorted = [...allContacts]; if (type === 'new') sorted.sort((a,b) => b.rowIndex - a.rowIndex); else if (type === 'name') sorted.sort((a,b) => (a.name||'').localeCompare(b.name||'', 'zh-Hant')); else if (type === 'company') sorted.sort((a,b) => (a.company||'').localeCompare(b.company||'', 'zh-Hant')); else if (type === 'tag') sorted.sort((a,b) => (a.tag||'').localeCompare(b.tag||'', 'zh-Hant')); allContacts = sorted; applyFilter(); }
  function scrollToTop() { window.scrollTo({ top: 0, behavior: 'smooth' }); }
  window.onscroll = function() { const btn = document.getElementById('scrollTopBtn'); if (document.body.scrollTop > 300 || document.documentElement.scrollTop > 300) btn.classList.add('show'); else btn.classList.remove('show'); };
  
  function initSwipeBack() {
    const modal = document.getElementById('detailModal'); const modalBody = modal.querySelector('.modal-body'); let startX = 0; let isSwiping = false;
    modal.addEventListener('touchstart', (e) => { if (modalBody.scrollTop > 0) return; startX = e.touches[0].clientX; if (startX < 35) isSwiping = true; else isSwiping = false; }, {passive: true});
    modal.addEventListener('touchmove', (e) => { if (!isSwiping) return; const diffX = e.touches[0].clientX - startX; if (diffX > 0) { modal.style.transition = 'none'; modal.style.transform = `translateX(${diffX}px)`; } }, {passive: true});
    modal.addEventListener('touchend', (e) => { if (!isSwiping) return; isSwiping = false; const diffX = e.changedTouches[0].clientX - startX; modal.style.transition = 'transform 0.3s cubic-bezier(0.32, 0.72, 0, 1)'; if (diffX > 100) { modal.style.transform = 'translateX(100%)'; setTimeout(() => { closeModal('detailModal'); modal.style.transform = ''; }, 300); } else { modal.style.transform = ''; } });
  }

  function updateUrlHash() {
    var currentTheme = document.documentElement.getAttribute('data-theme') || 'light';
    var tabString = '';
    if (typeof savedTabOrder !== 'undefined' && Array.isArray(savedTabOrder)) {
      tabString = savedTabOrder.join(',');
    }
    var hashParts = [];
    if (currentTheme === 'dark') hashParts.push('theme=dark');
    if (tabString) hashParts.push('tabs=' + encodeURIComponent(tabString));
    if (hashParts.length > 0) {
      window.history.replaceState(null, null, '#' + hashParts.join('&'));
    } else {
      window.history.replaceState(null, null, window.location.pathname + window.location.search);
    }
  }

  function loadFromUrlHash() {
    try {
      var hash = window.location.hash.substring(1);
      if (!hash) return;
      var params = {};
      hash.split('&').forEach(function(part) {
        var item = part.split('=');
        if (item.length === 2) params[item[0]] = decodeURIComponent(item[1]);
      });
      if (params['theme'] === 'dark') {
        document.documentElement.setAttribute('data-theme', 'dark');
        localStorage.setItem('app_theme', 'dark');
        var icon = document.getElementById('themeIcon');
        if (icon) { icon.classList.remove('fa-moon'); icon.classList.add('fa-sun'); }
      }
      if (params['tabs']) {
        var newOrder = params['tabs'].split(',');
        if (newOrder.length > 0) {
          savedTabOrder = newOrder;
          localStorage.setItem('tabOrder_v1', JSON.stringify(newOrder));
        }
      }
    } catch (e) {
      console.log('Error loading hash:', e);
    }
  }
</script>

</body>
</html>
