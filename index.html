<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <base target="_top">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
  <title>Meishi Box </title>
  
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css">
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
  
  <script>
  // ⚠️ 請務必將下方網址換成您 GAS 部署後的網址 (以 /exec 結尾)
  const GAS_URL = 'https://script.google.com/macros/s/AKfycby6XDg1Ts6iiqbpccamjGkTptN3NM_E6hXVZ64zsH3sKRZ7JJYw6f7sEzphESGAbQSL/exec';

  let allContacts = [];
  let cropper = null;
  let currentTab = '全部';
  let isSelectionMode = false; 
  let selectedRows = new Set(); 
  let savedTabOrder = JSON.parse(localStorage.getItem('tabOrder_v1')) || [];
  let customTagColors = JSON.parse(localStorage.getItem('tag_colors')) || {};
  let pressTimer;
  let isLongPressTriggered = false;
  let lastTouchTime = 0;
  let tabPressTimer; 
  let selectedTabForAction = null;
  let pendingColor = null;

  const defaultAvatar = "https://cdn-icons-png.flaticon.com/512/847/847969.png"; 
  const formPlaceholder = "https://cdn-icons-png.flaticon.com/512/847/847969.png";

  /* --- API 通用呼叫函式 (取代 google.script.run) --- */
  function callApi(action, params = {}) {
    // 組合要傳給後端的資料
    const payload = { action: action, ...params };
    
    return fetch(GAS_URL, {
      method: "POST",
      body: JSON.stringify(payload)
    })
    .then(res => res.json()); // 解析 JSON
  }

  // GET 請求專用 (用於讀取資料)
  function callGetApi(action) {
    return fetch(`${GAS_URL}?action=${action}`)
      .then(res => res.json());
  }

  /* --- 主程式開始 --- */

  window.onload = function() {
    if (typeof loadFromUrlHash === 'function') loadFromUrlHash();
    initTheme(); 
    initLoad(); // 這裡會去呼叫 API
    initSwipeBack(); 
    
    var closeMenuHandler = function(e) {
      if (!e.target.closest('.context-menu')) {
        var menu = document.getElementById('tabContextMenu');
        if (menu && menu.style.display !== 'none') menu.style.display = 'none';
      }
    };
    document.addEventListener('mousedown', closeMenuHandler);
    document.addEventListener('touchstart', closeMenuHandler);
  };
  
  // Ghost Click Fix
  function startPress(e, rowIndex) {
    if (e.type === 'touchstart') lastTouchTime = Date.now();
    else if (e.type === 'mousedown') { if (Date.now() - lastTouchTime < 800) return; }
    isLongPressTriggered = false;
    pressTimer = setTimeout(() => { triggerSelection(rowIndex); }, 600);
  }
  function cancelPress() { clearTimeout(pressTimer); }
  function handleRightClick(rowIndex) { clearTimeout(pressTimer); triggerSelection(rowIndex); }

  function triggerSelection(rowIndex) {
    isLongPressTriggered = true; 
    if (navigator.vibrate) navigator.vibrate(50);
    if (!isSelectionMode) toggleSelectionMode(true);
    const strRow = rowIndex.toString();
    if (!selectedRows.has(strRow)) selectedRows.add(strRow);
    updateBatchUI(); renderListHTML(); 
  }

  function handleCardClick(jsonStr, rowIndex) {
    if (isLongPressTriggered) { isLongPressTriggered = false; return; }
    if (isSelectionMode) {
      const strRow = rowIndex.toString();
      if (selectedRows.has(strRow)) selectedRows.delete(strRow); else selectedRows.add(strRow);
      updateBatchUI(); renderListHTML();
    } else {
      const item = JSON.parse(decodeURIComponent(jsonStr));
      openDetailModal(item, item.imageUrl, null);
    }
  }

  // --- Tab Logic ---
  function startTabPress(e, tag) {
    if (tag === '全部' || tag === '未分類') return;
    if (navigator.vibrate) navigator.vibrate(50);
    tabPressTimer = setTimeout(() => { showTabContextMenu(e, tag); }, 600);
  }
  function cancelTabPress() { clearTimeout(tabPressTimer); }

  function showTabContextMenu(e, tag) {
    if (tag === '全部' || tag === '未分類') return; 
    e.preventDefault();
    selectedTabForAction = tag;
    pendingColor = customTagColors[tag] || '#007AFF';
    const menu = document.getElementById('tabContextMenu');
    let x = e.clientX || (e.touches && e.touches[0].clientX);
    let y = e.clientY || (e.touches && e.touches[0].clientY);
    if (x + 150 > window.innerWidth) x = window.innerWidth - 160;
    menu.style.left = x + 'px';
    menu.style.top = y + 'px';
    menu.style.display = 'flex';
  }

  // Rename Logic
  function openRenameModal() {
    document.getElementById('tabContextMenu').style.display = 'none';
    document.getElementById('renameInput').value = selectedTabForAction;
    document.getElementById('renameModal').classList.add('active');
    setTimeout(() => document.getElementById('renameInput').focus(), 100);
  }

  function confirmRename() {
    const oldName = selectedTabForAction;
    const newName = document.getElementById('renameInput').value.trim();
    closeModal('renameModal');

    if (newName && newName !== oldName) {
      showLoading('更新中...');
      allContacts.forEach(c => { if(c.tag === oldName) c.tag = newName; });
      if(customTagColors[oldName]) {
        customTagColors[newName] = customTagColors[oldName];
        delete customTagColors[oldName];
        localStorage.setItem('tag_colors', JSON.stringify(customTagColors));
        // [API] 同步更名後的顏色
        callApi('saveCloudSettings', { settings: { tagColors: customTagColors } });
      }
      
      // [API] 呼叫後端更名
      callApi('batchRenameTag', { oldTag: oldName, newTag: newName })
        .then(res => {
            hideLoading();
            if(res.status === 'success') {
              renderTabs();
              if(currentTab === oldName) switchTab(newName); else applyFilter();
              showToast('更名成功');
            } else alert(res.message);
        })
        .catch(err => { hideLoading(); alert('連線錯誤: ' + err); });
    }
  }

  // Color Picker Logic
  function openColorModal() {
    document.getElementById('tabContextMenu').style.display = 'none';
    document.getElementById('colorPreview').style.background = pendingColor;
    document.querySelectorAll('.color-circle').forEach(el => el.classList.remove('selected'));
    document.getElementById('colorModal').classList.add('active');
  }

  function triggerCustomColor() { document.getElementById('hiddenColorInput').click(); }

  function selectColor(color, element) {
    pendingColor = color;
    document.getElementById('colorPreview').style.background = color;
    document.querySelectorAll('.color-circle').forEach(el => el.classList.remove('selected'));
    if(element) element.classList.add('selected');
  }

  function saveSelectedColor() {
    if (selectedTabForAction && pendingColor) {
      customTagColors[selectedTabForAction] = pendingColor;
      localStorage.setItem('tag_colors', JSON.stringify(customTagColors));
      applyFilter(); 
      showToast('顏色已更新');
      closeModal('colorModal');
      // [API] 同步顏色到雲端
      callApi('saveCloudSettings', { settings: { tagColors: customTagColors } });
    }
  }

  // --- Core Functions (Load & Render) ---
  function initLoad() {
    if(isSelectionMode) toggleSelectionMode(false);
    const icon = document.getElementById('refreshIcon');
    if(icon) icon.classList.add('fa-spin');

    // [API] 1. 先讀取雲端設定 (使用 GET)
    callGetApi('getCloudSettings')
      .then(settings => {
        // 恢復設定
        if (settings.theme === 'dark') {
          document.documentElement.setAttribute('data-theme', 'dark');
          const tIcon = document.getElementById('themeIcon');
          if(tIcon) { tIcon.classList.remove('fa-moon'); tIcon.classList.add('fa-sun'); }
        }
        if (settings.tabOrder && settings.tabOrder.length > 0) {
          savedTabOrder = settings.tabOrder;
          localStorage.setItem('tabOrder_v1', JSON.stringify(savedTabOrder));
        }
        if (settings.tagColors) {
          customTagColors = settings.tagColors;
          localStorage.setItem('tag_colors', JSON.stringify(customTagColors));
        }
        // [API] 2. 再讀取資料清單 (使用 GET)
        return callGetApi('getContactList');
      })
      .then(res => {
         renderList(res); // 渲染畫面
      })
      .catch(err => {
         hideLoading();
         alert('載入失敗，請檢查 GAS 部署權限是否為「所有人」。\n錯誤: ' + err);
      });
  }

  function renderList(res) {
    if(res.status !== 'success') { hideLoading(); alert(res.message); return; }
    allContacts = res.data;
    renderTabs(); 
    applyFilter();
    hideLoading(); 
  }

  function applyFilter() {
    const q = document.getElementById('searchInput').value.toLowerCase();
    toggleSearchClear(); 
    const filtered = allContacts.filter(item => {
      let matchTag = false;
      if (currentTab === '全部') matchTag = true;
      else if (currentTab === '未分類') matchTag = !item.tag || item.tag.trim() === '';
      else matchTag = (item.tag === currentTab);
      const str = (item.name + item.company + item.title + item.phone + item.tax_id + (item.tag||'')).toLowerCase();
      return matchTag && str.includes(q);
    });
    generateHtml(filtered);
  }

  function renderListHTML() { applyFilter(); }

  function generateHtml(data) {
    const listDiv = document.getElementById('contactList');
    if(data.length === 0) { listDiv.innerHTML = '<div style="text-align:center;padding:60px 20px;color:var(--text-sec);font-size:14px;">暫無符合的資料</div>'; return; }
    
    let html = '';
    data.forEach(item => {
      let img = (item.imageUrl && item.imageUrl.startsWith('http')) ? item.imageUrl : defaultAvatar;
      const jsonStr = encodeURIComponent(JSON.stringify(item));
      let tagLabel = '';
      if(item.tag) {
          const bg = stringToColor(item.tag);
          tagLabel = `<span class="tag-badge" style="background:${bg}">${item.tag}</span>`;
      }
      const isChecked = selectedRows.has(item.rowIndex.toString()) ? 'checked' : '';

      html += `
        <div class="contact-card" 
             oncontextmenu="handleRightClick('${item.rowIndex}'); return false;"
             ontouchstart="startPress(event, '${item.rowIndex}')" 
             ontouchend="cancelPress()" 
             ontouchmove="cancelPress()" 
             onmousedown="startPress(event, '${item.rowIndex}')" 
             onmouseup="cancelPress()" 
             onmouseleave="cancelPress()"
             onclick="handleCardClick('${jsonStr}', '${item.rowIndex}')">
          <div class="select-checkbox ${isChecked}" id="chk-${item.rowIndex}"></div>
          <img src="${img}" class="avatar">
          <div class="info">
            <div style="display:flex; justify-content:space-between; align-items:flex-start;">
               <div class="name">${item.name || '未命名'}</div>
               ${tagLabel}
            </div>
            <div class="title">${item.title || ''}</div>
            <div class="company">${item.company || ''}</div>
          </div>
        </div>`;
    });
    listDiv.innerHTML = html;
  }

  function toggleSelectionMode(forceState) {
    if (typeof forceState !== 'undefined') isSelectionMode = forceState;
    else isSelectionMode = !isSelectionMode;

    const btnText = document.getElementById('btnSelect');
    const contactList = document.getElementById('contactList');
    const batchBar = document.getElementById('batchBar');
    const fabGroup = document.getElementById('fabGroup');

    if(isSelectionMode) {
      btnText.innerText = "完成";
      btnText.classList.add('primary');
      contactList.classList.add('selection-mode');
      batchBar.classList.add('active');
      fabGroup.style.transform = 'translateY(200%)'; 
    } else {
      btnText.innerText = "選取";
      btnText.classList.remove('primary');
      contactList.classList.remove('selection-mode');
      batchBar.classList.remove('active');
      fabGroup.style.transform = 'translateY(0)';
      selectedRows.clear();
      applyFilter(); 
    }
    updateBatchUI();
  }

  function updateBatchUI() { document.getElementById('batchInfo').innerText = `已選取 ${selectedRows.size} 筆`; }

  function renderTabs() {
    const rawTabs = new Set(['全部', '未分類']);
    allContacts.forEach(item => { if(item.tag && item.tag.trim() !== '') rawTabs.add(item.tag.trim()); });
    let tabsArray = Array.from(rawTabs);
    if (savedTabOrder.length > 0) {
      tabsArray.sort((a, b) => {
        const indexA = savedTabOrder.indexOf(a); const indexB = savedTabOrder.indexOf(b);
        if (indexA !== -1 && indexB !== -1) return indexA - indexB;
        if (a === '全部') return -1; if (b === '全部') return 1; if (a === '未分類') return -1; if (b === '未分類') return 1;
        if (indexA !== -1) return -1; if (indexB !== -1) return 1; return 0;
      });
    } else {
        tabsArray.sort((a, b) => { if (a === '全部') return -1; if (b === '全部') return 1; if (a === '未分類') return -1; if (b === '未分類') return 1; return 0; });
    }

    const tabBar = document.getElementById('tabBar');
    const tagOptions = document.getElementById('tagOptions');
    let tabHtml = ''; let optionsHtml = '';

    tabsArray.forEach(tag => {
      const activeClass = (tag === currentTab) ? 'active' : '';
      tabHtml += `<div class="tab-item ${activeClass}" data-id="${tag}" 
                       onclick="switchTab('${tag}')"
                       oncontextmenu="showTabContextMenu(event, '${tag}'); return false;"
                       ontouchstart="startTabPress(event, '${tag}')"
                       ontouchend="cancelTabPress()"
                       ontouchmove="cancelTabPress()">${tag}</div>`;
      if(tag !== '全部' && tag !== '未分類') optionsHtml += `<option value="${tag}">`;
    });
    tabBar.innerHTML = tabHtml;
    tagOptions.innerHTML = optionsHtml;

    new Sortable(tabBar, {
      animation: 150, delay: 200, touchStartThreshold: 10, delayOnTouchOnly: false, ghostClass: 'sortable-ghost',
      onEnd: function (evt) {
        const newOrder = Array.from(tabBar.querySelectorAll('.tab-item')).map(el => el.getAttribute('data-id'));
        localStorage.setItem('tabOrder_v1', JSON.stringify(newOrder));
        savedTabOrder = newOrder;
        updateUrlHash();
        // [API] 同步頁籤順序
        callApi('saveCloudSettings', { settings: { tabOrder: newOrder } });
      }
    });
  }

  function switchTab(tag) {
    currentTab = tag;
    document.querySelectorAll('.tab-item').forEach(el => {
      if(el.getAttribute('data-id') === tag) el.classList.add('active'); else el.classList.remove('active');
    });
    applyFilter();
  }

  function stringToColor(str) {
    if (customTagColors[str]) return customTagColors[str];
    let hash = 0; for (let i = 0; i < str.length; i++) { hash = str.charCodeAt(i) + ((hash << 5) - hash); }
    const hue = Math.abs(hash) % 360; return `hsl(${hue}, 60%, 50%)`; 
  }

  function makeCall(inputId) {
    const val = document.getElementById(inputId).value;
    if (val) window.open('tel:' + val, '_self'); else showToast('無電話號碼');
  }

  function openMap() {
    const val = document.getElementById('inputAddress').value;
    if (val) window.open('https://www.google.com/maps/search/?api=1&query=' + encodeURIComponent(val), '_blank'); else showToast('無地址資料');
  }

  function copyContactInfo() {
    const name = document.getElementById('inputName').value;
    const title = document.getElementById('inputTitle').value;
    const company = document.getElementById('inputCompany').value;
    const mobile = document.getElementById('inputPhone').value;
    const tel = document.getElementById('inputTelCompany').value;
    const email = document.getElementById('inputEmail').value;
    const address = document.getElementById('inputAddress').value;
    const taxId = document.getElementById('inputTaxId').value;
    const note = document.getElementById('inputNote').value;
    let text = `【名片資訊】\n`;
    if(name) text += `姓名：${name} ${title ? '('+title+')' : ''}\n`;
    if(company) text += `公司：${company}\n`;
    if(mobile) text += `手機：${mobile}\n`;
    if(tel) text += `電話：${tel}\n`;
    if(email) text += `信箱：${email}\n`;
    if(address) text += `地址：${address}\n`;
    if(taxId) text += `統編：${taxId}\n`;
    if(note) text += `備註：${note}\n`;
    navigator.clipboard.writeText(text).then(() => { showToast('已複製'); }).catch(() => { showToast('複製失敗'); });
  }

  function copyField(inputId) {
    var val = document.getElementById(inputId).value;
    if (val) navigator.clipboard.writeText(val).then(() => showToast('已複製')).catch(() => showToast('複製失敗'));
    else showToast('無內容');
  }

  function toggleSearchClear() {
    const val = document.getElementById('searchInput').value;
    document.getElementById('searchClearBtn').style.display = val.length > 0 ? 'block' : 'none';
  }
  function clearSearch() { document.getElementById('searchInput').value = ''; toggleSearchClear(); applyFilter(); }

  // Theme, Loading, Toast
  function initTheme() {
    const savedTheme = localStorage.getItem('app_theme');
    const icon = document.getElementById('themeIcon');
    if (savedTheme === 'dark') { document.documentElement.setAttribute('data-theme', 'dark'); icon.classList.remove('fa-moon'); icon.classList.add('fa-sun'); }
    else { document.documentElement.removeAttribute('data-theme'); icon.classList.remove('fa-sun'); icon.classList.add('fa-moon'); }
  }

  function toggleTheme() {
    const currentTheme = document.documentElement.getAttribute('data-theme');
    const icon = document.getElementById('themeIcon');
    let newTheme = 'light';
    if (currentTheme === 'dark') { 
      document.documentElement.removeAttribute('data-theme'); 
      newTheme = 'light';
      icon.classList.remove('fa-sun'); icon.classList.add('fa-moon'); 
    } else { 
      document.documentElement.setAttribute('data-theme', 'dark'); 
      newTheme = 'dark';
      icon.classList.remove('fa-moon'); icon.classList.add('fa-sun'); 
    }
    localStorage.setItem('app_theme', newTheme);
    updateUrlHash(); 
    // [API] 同步主題
    callApi('saveCloudSettings', { settings: { theme: newTheme } });
  }

  function showLoading(txt) { document.getElementById('loadingText').innerText = txt || '處理中...'; document.getElementById('loader').style.display = 'flex'; }
  function hideLoading() { document.getElementById('loader').style.display = 'none'; const icon = document.getElementById('refreshIcon'); if(icon) icon.classList.remove('fa-spin'); }
  function showToast(msg) { const el = document.getElementById('toast'); el.innerText = msg; el.classList.add('show'); setTimeout(() => { el.classList.remove('show'); }, 2000); }

  // Modals & Forms
  function openBatchTagModal() {
    if(selectedRows.size === 0) { showToast('請先選取資料'); return; }
    const inputTag = document.getElementById('batchInputTag');
    const warningBox = document.getElementById('batchWarning');
    const btnConfirm = document.getElementById('btnConfirmBatchTag');
    inputTag.value = '';
    let hasExistingTags = false;
    selectedRows.forEach(rowStr => { const contact = allContacts.find(c => c.rowIndex == rowStr); if (contact && contact.tag && contact.tag.trim() !== '') hasExistingTags = true; });
    if (hasExistingTags) { warningBox.style.display = 'flex'; inputTag.disabled = true; inputTag.placeholder = "請先移除舊標籤"; btnConfirm.disabled = true; }
    else { warningBox.style.display = 'none'; inputTag.disabled = false; inputTag.placeholder = "輸入標籤"; btnConfirm.disabled = false; }
    document.getElementById('batchTagModal').classList.add('active');
  }
  
  function confirmBatchTag(isDelete = false) {
    let newTag = document.getElementById('batchInputTag').value;
    if (isDelete === true) { if (!confirm('確定要移除這些聯絡人的標籤嗎？')) return; newTag = ""; }
    else { if (document.getElementById('batchInputTag').disabled) return; if (!newTag) { showToast('請輸入標籤'); return; } }
    
    closeModal('batchTagModal'); showLoading();
    const rows = Array.from(selectedRows);
    
    // [API] 批次更新
    callApi('batchUpdateTags', { rowIndices: rows, newTag: newTag })
      .then(res => {
        hideLoading();
        if(res.status === 'success') { showToast(res.message); toggleSelectionMode(false); initLoad(); } else { alert(res.message); }
      })
      .catch(err => { hideLoading(); alert('錯誤: ' + err); });
  }

  function executeBatchDelete() {
    if(selectedRows.size === 0) { showToast('請先選取資料'); return; }
    if(!confirm(`確定要刪除這 ${selectedRows.size} 筆資料嗎？`)) return;
    showLoading(); const rows = Array.from(selectedRows);
    
    // [API] 批次刪除
    callApi('batchDeleteContacts', { rowIndices: rows })
      .then(res => {
        hideLoading();
        if(res.status === 'success') { showToast(res.message); toggleSelectionMode(false); initLoad(); } else { alert(res.message); }
      })
      .catch(err => { hideLoading(); alert('錯誤: ' + err); });
  }

  function openManualAdd() { toggleFab(); openDetailModal({}, '', formPlaceholder); }
  function triggerLocalUpload() { document.getElementById('localImgInput').click(); }
  function toggleFab() { document.getElementById('fabMenu').classList.toggle('show'); document.querySelector('.fab-main i').classList.toggle('fa-plus'); document.querySelector('.fab-main i').classList.toggle('fa-times'); }
  function triggerFile(type) { toggleFab(); if(type === 'upload') document.getElementById('fileInput').click(); else document.getElementById('cameraInput').click(); }
  function handleFileSelect(input) { if (input.files && input.files[0]) { const file = input.files[0]; const reader = new FileReader(); reader.onload = function(e) { openCropModal(e.target.result); }; reader.readAsDataURL(file); input.value = ''; } }
  
  function openCropModal(imgSrc) {
    const img = document.getElementById('cropImage');
    const modalBody = document.getElementById('cropModalBody');
    const toolbar = document.getElementById('cropToolbar');
    img.src = imgSrc; img.style.opacity = '0'; toolbar.classList.remove('show');
    document.getElementById('cropModal').classList.add('active');
    if (cropper) cropper.destroy();
    modalBody.classList.add('scanning');
    setTimeout(() => { modalBody.classList.remove('scanning'); img.style.opacity = '1'; toolbar.classList.add('show'); cropper = new Cropper(img, { viewMode: 1, dragMode: 'move', autoCropArea: 0.8, restore: false, guides: true, center: true, highlight: false, cropBoxMovable: true, cropBoxResizable: true, toggleDragModeOnDblclick: false }); }, 1200);
  }

  function confirmCrop() { 
    if (!cropper) return; 
    showLoading('AI 辨識中...'); 
    const croppedCanvas = cropper.getCroppedCanvas({ width: 800 }); 
    const base64Data = croppedCanvas.toDataURL('image/jpeg').split(',')[1]; 
    closeModal('cropModal'); 
    document.getElementById('cropToolbar').classList.remove('show'); 
    document.getElementById('cropImage').style.opacity = '0'; 
    
    // [API] 名片辨識
    callApi('processBusinessCard', { base64Data: base64Data, fileName: 'cropped_card.jpg' })
      .then(res => {
        hideLoading();
        if(res.status === 'success') { 
            openDetailModal(res.data, res.imageUrl, croppedCanvas.toDataURL('image/jpeg')); 
        } else { 
            alert('分析失敗: ' + res.message); 
        }
      })
      .catch(err => { hideLoading(); alert('連線錯誤: ' + err); });
  }

  function handleLocalImage(input) { if (input.files && input.files[0]) { const file = input.files[0]; const img = document.createElement('img'); const url = URL.createObjectURL(file); img.onload = function() { const MAX_WIDTH = 800; let width = img.width; let height = img.height; if (width > MAX_WIDTH) { height *= MAX_WIDTH / width; width = MAX_WIDTH; } const canvas = document.createElement('canvas'); canvas.width = width; canvas.height = height; const ctx = canvas.getContext('2d'); ctx.drawImage(img, 0, 0, width, height); const compressedDataUrl = canvas.toDataURL('image/jpeg', 0.7); document.getElementById('previewImg').src = compressedDataUrl; document.getElementById('imgUrlHidden').value = compressedDataUrl; URL.revokeObjectURL(url); }; img.src = url; } }
  function removePreviewImage() { document.getElementById('previewImg').src = formPlaceholder; document.getElementById('imgUrlHidden').value = ""; }
  
  function openDetailModal(data, driveUrl, localBase64) {
    document.getElementById('formTitle').innerText = data.rowIndex ? '編輯資料' : '新增名片'; document.getElementById('rowIndex').value = data.rowIndex || ''; document.getElementById('imgUrlHidden').value = driveUrl || ''; document.getElementById('previewImg').src = localBase64 ? localBase64 : (driveUrl && driveUrl.startsWith('http') ? driveUrl : formPlaceholder);
    document.getElementById('inputName').value = data.name || ''; document.getElementById('inputTitle').value = data.title || ''; document.getElementById('inputCompany').value = data.company || ''; document.getElementById('inputPhone').value = data.mobile || data.phone || ''; document.getElementById('inputTelCompany').value = data.tel_company || ''; document.getElementById('inputEmail').value = data.email || ''; document.getElementById('inputWebsite').value = data.website || ''; document.getElementById('inputAddress').value = data.address || ''; document.getElementById('inputTaxId').value = data.tax_id || ''; document.getElementById('inputNote').value = data.note || ''; document.getElementById('inputTag').value = data.tag || '';
    document.getElementById('detailModal').classList.add('active');
  }

  function saveContact() {
    const formData = { rowIndex: document.getElementById('rowIndex').value, name: document.getElementById('inputName').value, title: document.getElementById('inputTitle').value, company: document.getElementById('inputCompany').value, phone: document.getElementById('inputPhone').value, tel_company: document.getElementById('inputTelCompany').value, email: document.getElementById('inputEmail').value, address: document.getElementById('inputAddress').value, website: document.getElementById('inputWebsite').value, tax_id: document.getElementById('inputTaxId').value, note: document.getElementById('inputNote').value, tag: document.getElementById('inputTag').value, imageUrl: document.getElementById('imgUrlHidden').value };
    if (!formData.name) { showToast('請輸入姓名'); return; } 
    showLoading();
    
    // [API] 判斷是新增還是更新
    const action = formData.rowIndex ? 'updateContactInSheet' : 'saveContactToSheet';
    
    callApi(action, { formData: formData })
      .then(res => {
        hideLoading();
        if(res.status === 'success') { 
            showToast(res.message); 
            closeModal('detailModal'); 
            initLoad(); 
        } else { 
            alert(res.message); 
        }
      })
      .catch(err => { hideLoading(); alert('儲存失敗: ' + err); });
  }

  function closeModal(id) { document.getElementById(id).classList.remove('active'); }
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
      var tabMenu = document.getElementById('tabContextMenu');
      if (tabMenu && tabMenu.style.display !== 'none') { tabMenu.style.display = 'none'; return; }
      if (document.getElementById('cropModal').classList.contains('active')) closeModal('cropModal');
      else if (document.getElementById('detailModal').classList.contains('active')) closeModal('detailModal');
      else if (document.getElementById('batchTagModal').classList.contains('active')) closeModal('batchTagModal');
      else if (document.getElementById('renameModal').classList.contains('active')) closeModal('renameModal');
      else if (document.getElementById('colorModal').classList.contains('active')) closeModal('colorModal');
      else if (isSelectionMode) toggleSelectionMode(false);
    }
  });

  function sortList(type) { let sorted = [...allContacts]; if (type === 'new') sorted.sort((a,b) => b.rowIndex - a.rowIndex); else if (type === 'name') sorted.sort((a,b) => (a.name||'').localeCompare(b.name||'', 'zh-Hant')); else if (type === 'company') sorted.sort((a,b) => (a.company||'').localeCompare(b.company||'', 'zh-Hant')); else if (type === 'tag') sorted.sort((a,b) => (a.tag||'').localeCompare(b.tag||'', 'zh-Hant')); allContacts = sorted; applyFilter(); }
  function scrollToTop() { window.scrollTo({ top: 0, behavior: 'smooth' }); }
  window.onscroll = function() { const btn = document.getElementById('scrollTopBtn'); if (document.body.scrollTop > 300 || document.documentElement.scrollTop > 300) btn.classList.add('show'); else btn.classList.remove('show'); };
  
  function initSwipeBack() {
    const modal = document.getElementById('detailModal'); const modalBody = modal.querySelector('.modal-body'); let startX = 0; let isSwiping = false;
    modal.addEventListener('touchstart', (e) => { if (modalBody.scrollTop > 0) return; startX = e.touches[0].clientX; if (startX < 35) isSwiping = true; else isSwiping = false; }, {passive: true});
    modal.addEventListener('touchmove', (e) => { if (!isSwiping) return; const diffX = e.touches[0].clientX - startX; if (diffX > 0) { modal.style.transition = 'none'; modal.style.transform = `translateX(${diffX}px)`; } }, {passive: true});
    modal.addEventListener('touchend', (e) => { if (!isSwiping) return; isSwiping = false; const diffX = e.changedTouches[0].clientX - startX; modal.style.transition = 'transform 0.3s cubic-bezier(0.32, 0.72, 0, 1)'; if (diffX > 100) { modal.style.transform = 'translateX(100%)'; setTimeout(() => { closeModal('detailModal'); modal.style.transform = ''; }, 300); } else { modal.style.transform = ''; } });
  }
  
  function updateUrlHash() {
    var currentTheme = document.documentElement.getAttribute('data-theme') || 'light';
    var tabString = '';
    if (typeof savedTabOrder !== 'undefined' && Array.isArray(savedTabOrder)) tabString = savedTabOrder.join(',');
    var hashParts = [];
    if (currentTheme === 'dark') hashParts.push('theme=dark');
    if (tabString) hashParts.push('tabs=' + encodeURIComponent(tabString));
    if (hashParts.length > 0) window.history.replaceState(null, null, '#' + hashParts.join('&'));
    else window.history.replaceState(null, null, window.location.pathname + window.location.search);
  }

  function loadFromUrlHash() {
    try {
      var hash = window.location.hash.substring(1);
      if (!hash) return;
      var params = {};
      hash.split('&').forEach(function(part) { var item = part.split('='); if (item.length === 2) params[item[0]] = decodeURIComponent(item[1]); });
      if (params['theme'] === 'dark') {
        document.documentElement.setAttribute('data-theme', 'dark');
        localStorage.setItem('app_theme', 'dark');
        var icon = document.getElementById('themeIcon');
        if (icon) { icon.classList.remove('fa-moon'); icon.classList.add('fa-sun'); }
      }
      if (params['tabs']) {
        var newOrder = params['tabs'].split(',');
        if (newOrder.length > 0) { savedTabOrder = newOrder; localStorage.setItem('tabOrder_v1', JSON.stringify(newOrder)); }
      }
    } catch (e) { console.log('Error loading hash:', e); }
  }
</script>
</script>

</body>
</html>
